<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Details - City Maid Services</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            primary: '#4F46E5',
                            secondary: '#4338CA',
                            light: '#EEF2FF',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-poppins bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex items-center">
                    <a href="../index.html" class="text-3xl font-bold text-brand-primary tracking-tight">City<span class="text-brand-secondary"> Maid</span></a>
                </div>
                <!-- Mobile menu button -->
                <div class="flex items-center md:hidden">
                    <button id="mobileMenuBtn" class="text-gray-700 hover:text-brand-primary focus:outline-none" aria-label="Open menu">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
                <!-- Desktop menu -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="../index.html" class="nav-link" data-page="home">Home</a>
                    <a href="find-maids.html" class="nav-link" data-page="find-maids" id="findMaidsLink">Find Maids</a>
                    <a href="find-jobs.html" class="nav-link active" data-page="find-jobs" id="findJobsLink">Find Jobs</a>
                    <a href="../auth/login.html" class="bg-brand-primary text-white px-6 py-2 rounded-lg hover:bg-brand-secondary font-semibold transition-colors">
                        Sign In
                    </a>
                </div>
            </div>
        </div>
        <!-- Mobile menu panel -->
        <div id="mobileMenu" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-50">
            <div class="fixed inset-y-0 right-0 max-w-xs w-full bg-white shadow-xl">
                <div class="flex items-center justify-between p-4 border-b">
                    <div class="flex items-center space-x-4">
                        <button onclick="window.history.back()" class="text-gray-500 hover:text-gray-700" aria-label="Go back">
                            <i class="fas fa-arrow-left text-xl"></i>
                        </button>
                        <a href="../index.html" class="text-gray-500 hover:text-gray-700" aria-label="Go to homepage">
                            <i class="fas fa-home text-xl"></i>
                        </a>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-900">Menu</h2>
                    <button id="closeMobileMenu" class="text-gray-500 hover:text-gray-700" aria-label="Close menu">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="p-4 space-y-4">
                    <a href="../index.html" class="block nav-link" data-page="home">Home</a>
                    <a href="find-maids.html" class="block nav-link" data-page="find-maids" id="mobileFindMaidsLink">Find Maids</a>
                    <a href="find-jobs.html" class="block nav-link active" data-page="find-jobs" id="mobileFindJobsLink">Find Jobs</a>
                    <div class="pt-4 border-t border-gray-200">
                        <a href="../auth/login.html" class="block text-gray-700 hover:text-brand-primary font-medium transition-colors mt-4">Sign In</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Job Details Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-primary"></div>
            <p class="mt-4 text-lg text-gray-600">Loading job details...</p>
        </div>

        <!-- Job Details Content (hidden until loaded) -->
        <div id="jobContent" class="hidden">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <!-- Header Section -->
                <div class="relative bg-brand-light py-10 px-8">
                    <div class="max-w-4xl">
                        <div class="flex items-center mb-4">
                            <span id="jobType" class="inline-flex items-center rounded-full bg-white px-3 py-1 text-sm font-medium text-brand-primary mr-3">
                                <i class="fas fa-clock mr-1"></i>
                                Type loading...
                            </span>
                            <span id="jobPosted" class="inline-flex items-center text-sm text-gray-600">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                Posted: <span id="jobPostedDate">Loading...</span>
                            </span>
                        </div>
                        <h1 id="jobTitle" class="text-3xl font-bold text-gray-900 mb-4">Job title loading...</h1>
                        <div class="flex items-center text-gray-700 mb-1">
                            <i class="fas fa-map-marker-alt mr-2 text-brand-primary"></i>
                            <span id="jobLocation">Location loading...</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-dollar-sign mr-2 text-brand-primary"></i>
                            <span id="jobSalary">Salary loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Details Section -->
                <div class="p-8">
                    <!-- Job Description -->
                    <div class="mb-10">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Job Description</h2>
                        <div id="jobDescription" class="prose max-w-none text-gray-700">
                            <p>Loading description...</p>
                        </div>
                    </div>
                    
                    <!-- Requirements -->
                    <div class="mb-10">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Requirements</h2>
                        <ul id="jobRequirements" class="list-disc pl-5 space-y-2 text-gray-700">
                            <li>Loading requirements...</li>
                        </ul>
                    </div>
                    
                    <!-- Employer Information -->
                    <div class="mb-10">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Employer Information</h2>
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mr-4">
                                <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
                                    <i class="fas fa-building text-gray-400 text-2xl"></i>
                                </div>
                            </div>
                            <div>
                                <h3 id="employerName" class="font-medium text-gray-900">Employer name loading...</h3>
                                <p id="employerLocation" class="text-gray-600">Location loading...</p>
                                <p id="employerJobs" class="text-gray-600">Posted jobs loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Application Section -->
                    <div class="border-t border-gray-200 pt-8">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Apply for this Job</h2>
                        <p class="text-gray-700 mb-6">Interested in this position? Sign in to apply or contact the employer directly.</p>
                        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                            <a href="../auth/login.html?redirect=jobs/find-jobs.html" class="bg-brand-primary text-white px-8 py-3 rounded-lg hover:bg-brand-secondary font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-user-circle mr-2"></i>
                                Sign In to Apply
                            </a>
                            <button id="contactEmployerBtn" class="border border-brand-primary text-brand-primary px-8 py-3 rounded-lg hover:bg-brand-light font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-envelope mr-2"></i>
                                Contact Employer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Similar Jobs -->
            <div class="mt-12">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Similar Jobs</h2>
                <div id="similarJobs" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Similar jobs will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-20">
            <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-medium text-gray-700 mb-2">Job Not Found</h3>
            <p class="text-gray-500 mb-6">We couldn't find this job listing. Please make sure you have the correct job ID in the URL.</p>
            <a href="find-jobs.html" class="bg-brand-primary text-white px-6 py-2 rounded-lg hover:bg-brand-secondary font-semibold transition-colors">
                Back to Find Jobs
            </a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">City Maid Services</h3>
                    <p class="text-gray-400">Connecting trusted domestic helpers with employers in your area.</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="../index.html" class="text-gray-400 hover:text-white transition-colors">Home</a></li>
                        <li><a href="find-maids.html" class="text-gray-400 hover:text-white transition-colors" id="footerFindMaidsLink">Find Maids</a></li>
                        <li><a href="find-jobs.html" class="text-gray-400 hover:text-white transition-colors" id="footerFindJobsLink">Find Jobs</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Contact</h3>
                    <ul class="space-y-2">
                        <li class="flex items-center text-gray-400">
                            <i class="fas fa-map-marker-alt mr-2"></i> Kathmandu, Nepal
                        </li>
                        <li class="flex items-center text-gray-400">
                            <i class="fas fa-phone mr-2"></i> +977 1234567
                        </li>
                        <li class="flex items-center text-gray-400">
                            <i class="fas fa-envelope mr-2"></i> info@citymaidservices.com
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Follow Us</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fab fa-facebook-f text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fab fa-instagram text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fab fa-linkedin-in text-xl"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; <span id="currentYear"></span> City Maid Services. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://fdgqqxyyofjnkhswkwcq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3FxeHl5b2Zqbmtoc3drd2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjQyMTMsImV4cCI6MjA1OTYwMDIxM30.YyJLLu3r2a7Mh7ny0ie-YzzLfPh5PdrJJHnBFBxWqVE';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Role-based navigation control
        function updateNavigationBasedOnRole() {
            const userRole = localStorage.getItem('userRole');
            
            // Get all navigation elements
            const findMaidsLink = document.getElementById('findMaidsLink');
            const findJobsLink = document.getElementById('findJobsLink');
            const mobileFindMaidsLink = document.getElementById('mobileFindMaidsLink');
            const mobileFindJobsLink = document.getElementById('mobileFindJobsLink');
            const footerFindMaidsLink = document.getElementById('footerFindMaidsLink');
            const footerFindJobsLink = document.getElementById('footerFindJobsLink');
            
            if (userRole === 'maid') {
                // Maids should see Find Jobs but not Find Maids
                if (findMaidsLink) findMaidsLink.classList.add('hidden');
                if (mobileFindMaidsLink) mobileFindMaidsLink.classList.add('hidden');
                if (footerFindMaidsLink) footerFindMaidsLink.classList.add('hidden');
                
                // Highlight Find Jobs as the active link for maids
                if (findJobsLink) {
                    findJobsLink.classList.remove('hidden');
                    findJobsLink.classList.add('active');
                }
                if (mobileFindJobsLink) {
                    mobileFindJobsLink.classList.remove('hidden');
                    mobileFindJobsLink.classList.add('active');
                }
                if (footerFindJobsLink) {
                    footerFindJobsLink.classList.remove('hidden');
                }
            } else if (userRole === 'employer') {
                // Employers should see Find Maids but not Find Jobs
                if (findJobsLink) findJobsLink.classList.add('hidden');
                if (mobileFindJobsLink) mobileFindJobsLink.classList.add('hidden');
                if (footerFindJobsLink) footerFindJobsLink.classList.add('hidden');
                
                // Highlight Find Maids as the active link for employers
                if (findMaidsLink) {
                    findMaidsLink.classList.remove('hidden');
                    findMaidsLink.classList.add('active');
                }
                if (mobileFindMaidsLink) {
                    mobileFindMaidsLink.classList.remove('hidden');
                    mobileFindMaidsLink.classList.add('active');
                }
                if (footerFindMaidsLink) {
                    footerFindMaidsLink.classList.remove('hidden');
                }
                
                // Redirect employer to employer dashboard since they shouldn't view job details
                window.location.href = '../employer/dashboard.html';
            }
        }

        // Sample job data (fallback if database fetch fails)
        const sampleJob = {
            id: 1,
            title: "Regular House Cleaning",
            location: "Kathmandu",
            job_type: "Regular",
            hourly_rate: 250,
            description: "Looking for a reliable maid for regular house cleaning in Kathmandu. Duties include sweeping, mopping, dusting, and kitchen cleaning. Must be available 3 days per week.",
            created_at: new Date().toISOString(),
            requirements: [
                "At least 1 year of experience in house cleaning",
                "Knowledge of proper cleaning techniques and products",
                "Reliable and punctual",
                "Good communication skills",
                "References from previous employers preferred"
            ],
            employer: {
                name: "Sharma Family",
                location: "Kathmandu",
                jobs_posted: 3
            }
        };

        // Sample similar jobs
        const sampleSimilarJobs = [
            {
                id: 2,
                title: "Weekly House Cleaning",
                location: "Lalitpur",
                job_type: "Weekly",
                hourly_rate: 280,
                created_at: new Date().toISOString()
            },
            {
                id: 3,
                title: "Office Cleaning Staff",
                location: "Kathmandu",
                job_type: "Full-time",
                hourly_rate: 220,
                created_at: new Date().toISOString()
            },
            {
                id: 4,
                title: "One-time Deep Cleaning",
                location: "Bhaktapur",
                job_type: "One-time",
                hourly_rate: 300,
                created_at: new Date().toISOString()
            }
        ];

        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // Mobile menu functionality
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            document.getElementById('mobileMenu').classList.remove('hidden');
        });

        document.getElementById('closeMobileMenu').addEventListener('click', function() {
            document.getElementById('mobileMenu').classList.add('hidden');
        });

        // Show error state - make this function more comprehensive
        function showError(customMessage) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('jobContent').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            
            // If custom message is provided, update the error message
            if (customMessage) {
                document.querySelector('#errorState h3').textContent = 'No Job ID Provided';
                document.querySelector('#errorState p').textContent = customMessage;
            }
        }

        // Get job ID from URL
        function getJobIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Format date nicely
        function formatDate(dateString) {
            if (!dateString) return 'Recently';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Recently';
            
            return new Intl.DateTimeFormat('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }).format(date);
        }

        // Fetch job details from Supabase
        async function fetchJobDetails() {
            const jobId = getJobIdFromUrl();
            
            if (!jobId) {
                showError('Please select a job from the find jobs page or make sure you have a job ID in the URL.');
                return;
            }
            
            try {
                console.log("Fetching job with ID:", jobId);
                
                // Try job_listings first
                let { data, error } = await supabaseClient
                    .from('job_listings')
                    .select('*')
                    .eq('id', jobId)
                    .single();
                
                if (error || !data) {
                    // Try jobs table
                    let { data: jobsData, error: jobsError } = await supabaseClient
                        .from('jobs')
                        .select('*')
                        .eq('id', jobId)
                        .single();
                    
                    if (jobsError || !jobsData) {
                        // Try employer_jobs
                        let { data: employerJobsData, error: employerJobsError } = await supabaseClient
                            .from('employer_jobs')
                            .select('*')
                            .eq('id', jobId)
                            .single();
                        
                        if (employerJobsError || !employerJobsData) {
                            // If all fail, use sample data
                            console.log("Using sample data");
                            displayJobDetails(sampleJob);
                            displaySimilarJobs(sampleSimilarJobs);
                        } else {
                            console.log("Job data from employer_jobs:", employerJobsData);
                            displayJobDetails(employerJobsData);
                            fetchSimilarJobs(employerJobsData);
                        }
                    } else {
                        console.log("Job data from jobs:", jobsData);
                        displayJobDetails(jobsData);
                        fetchSimilarJobs(jobsData);
                    }
                } else {
                    console.log("Job data from job_listings:", data);
                    displayJobDetails(data);
                    fetchSimilarJobs(data);
                }
            } catch (error) {
                console.error("Error fetching job:", error);
                displayJobDetails(sampleJob);
                displaySimilarJobs(sampleSimilarJobs);
            }
        }

        // Fetch similar jobs
        async function fetchSimilarJobs(currentJob) {
            try {
                let jobType = currentJob.job_type || currentJob.type || '';
                let location = currentJob.location || '';
                
                // Try to get similar jobs from job_listings
                let { data, error } = await supabaseClient
                    .from('job_listings')
                    .select('*')
                    .neq('id', currentJob.id)
                    .limit(3);
                
                if (error || !data || data.length === 0) {
                    // Try jobs table
                    let { data: jobsData, error: jobsError } = await supabaseClient
                        .from('jobs')
                        .select('*')
                        .neq('id', currentJob.id)
                        .limit(3);
                    
                    if (jobsError || !jobsData || jobsData.length === 0) {
                        // Try employer_jobs
                        let { data: employerJobsData, error: employerJobsError } = await supabaseClient
                            .from('employer_jobs')
                            .select('*')
                            .neq('id', currentJob.id)
                            .limit(3);
                        
                        if (employerJobsError || !employerJobsData || employerJobsData.length === 0) {
                            displaySimilarJobs(sampleSimilarJobs);
                        } else {
                            displaySimilarJobs(employerJobsData);
                        }
                    } else {
                        displaySimilarJobs(jobsData);
                    }
                } else {
                    displaySimilarJobs(data);
                }
            } catch (error) {
                console.error("Error fetching similar jobs:", error);
                displaySimilarJobs(sampleSimilarJobs);
            }
        }

        // Display job details
        function displayJobDetails(job) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('jobContent').classList.remove('hidden');
            
            // Basic info
            document.getElementById('jobTitle').textContent = job.title || job.job_title || 'Untitled Job';
            document.getElementById('jobLocation').textContent = job.location || job.work_location || 'Location not specified';
            document.getElementById('jobSalary').textContent = `₹${job.hourly_rate || job.salary || job.rate || 0}/hour`;
            document.getElementById('jobType').innerHTML = `<i class="fas fa-clock mr-1"></i> ${job.job_type || job.type || 'Not specified'}`;
            document.getElementById('jobPostedDate').textContent = formatDate(job.created_at);
            
            // Description
            document.getElementById('jobDescription').innerHTML = `<p>${job.description || job.details || 'No description available.'}</p>`;
            
            // Requirements
            const requirementsList = document.getElementById('jobRequirements');
            
            if (job.requirements && Array.isArray(job.requirements) && job.requirements.length > 0) {
                requirementsList.innerHTML = job.requirements.map(req => `<li>${req}</li>`).join('');
            } else {
                requirementsList.innerHTML = `
                    <li>At least 1 year of experience in house cleaning</li>
                    <li>Knowledge of proper cleaning techniques and products</li>
                    <li>Reliable and punctual</li>
                    <li>Good communication skills</li>
                    <li>References from previous employers preferred</li>
                `;
            }
            
            // Employer info
            if (job.employer) {
                document.getElementById('employerName').textContent = job.employer.name || 'Employer name not available';
                document.getElementById('employerLocation').textContent = job.employer.location || 'Location not specified';
                document.getElementById('employerJobs').textContent = job.employer.jobs_posted ? `${job.employer.jobs_posted} jobs posted` : '1 job posted';
            } else {
                document.getElementById('employerName').textContent = 'City Maid Services Employer';
                document.getElementById('employerLocation').textContent = job.location || 'Location not specified';
                document.getElementById('employerJobs').textContent = '1 job posted';
            }
            
            // Contact button
            document.getElementById('contactEmployerBtn').addEventListener('click', function() {
                alert('Contact feature coming soon! Please check back later.');
            });
        }

        // Display similar jobs
        function displaySimilarJobs(jobs) {
            const similarJobsContainer = document.getElementById('similarJobs');
            
            if (!jobs || jobs.length === 0) {
                similarJobsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No similar jobs found</p>';
                return;
            }
            
            similarJobsContainer.innerHTML = jobs.map(job => `
                <a href="view-detail.html?id=${job.id}" class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${job.title || job.job_title || 'Untitled Job'}</h3>
                        <div class="flex items-center text-gray-600 mb-2">
                            <i class="fas fa-map-marker-alt mr-2 text-brand-primary"></i>
                            <span>${job.location || job.work_location || 'Location not specified'}</span>
                        </div>
                        <div class="flex items-center text-gray-600 mb-2">
                            <i class="fas fa-clock mr-2 text-brand-primary"></i>
                            <span>${job.job_type || job.type || 'Not specified'}</span>
                        </div>
                        <div class="flex items-center text-gray-600 mb-4">
                            <i class="fas fa-dollar-sign mr-2 text-brand-primary"></i>
                            <span>₹${job.hourly_rate || job.salary || job.rate || 0}/hour</span>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-sm text-gray-500">Posted: ${formatDate(job.created_at)}</span>
                            <span class="text-brand-primary font-medium">View Details</span>
                        </div>
                    </div>
                </a>
            `).join('');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // First update navigation based on user role
            updateNavigationBasedOnRole();
            
            // Then fetch the job details
            fetchJobDetails();
        });
    </script>
</body>
</html> 