<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maid Profile - City Maid Services</title>
    <link href="../css/tailwind.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js"></script>
    <script src="https://khalti.s3.ap-south-1.amazonaws.com/KPG/dist/2020.12.17.0.0.0/khalti-checkout.iffe.js"></script>
    <script>
        // Initialize Tailwind configuration
        if (typeof window.tailwind !== 'undefined') {
            window.tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            primary: '#4F46E5',
                            secondary: '#4338CA',
                            light: '#EEF2FF',
                            }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-poppins bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex items-center">
                    <a href="../index.html" class="text-3xl font-bold text-brand-primary tracking-tight">City<span class="text-brand-secondary"> Maid</span></a>
                </div>
                <!-- Mobile menu button -->
                <div class="flex items-center md:hidden">
                    <button id="mobileMenuBtn" class="text-gray-700 hover:text-brand-primary focus:outline-none" aria-label="Open menu">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
                <!-- Desktop menu -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="../index.html" class="nav-link" data-page="home">Home</a>
                    <a href="find-maids.html" class="nav-link active" data-page="find-maids" id="findMaidsLink">Find Maids</a>
                    <a href="find-jobs.html" class="nav-link" data-page="find-jobs" id="findJobsLink">Find Jobs</a>
                    <a href="../auth/login.html" class="bg-brand-primary text-white px-6 py-2 rounded-lg hover:bg-brand-secondary font-semibold transition-colors">
                        Sign In
                    </a>
                </div>
            </div>
        </div>
        <!-- Mobile menu panel -->
        <div id="mobileMenu" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-50">
            <div class="fixed inset-y-0 right-0 max-w-xs w-full bg-white shadow-xl">
                <div class="flex items-center justify-between p-4 border-b">
                    <div class="flex items-center space-x-4">
                        <button onclick="window.history.back()" class="text-gray-500 hover:text-gray-700" aria-label="Go back">
                            <i class="fas fa-arrow-left text-xl"></i>
                        </button>
                        <a href="../index.html" class="text-gray-500 hover:text-gray-700" aria-label="Go to homepage">
                            <i class="fas fa-home text-xl"></i>
                        </a>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-900">Menu</h2>
                    <button id="closeMobileMenu" class="text-gray-500 hover:text-gray-700" aria-label="Close menu">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="p-4 space-y-4">
                    <a href="../index.html" class="block nav-link" data-page="home">Home</a>
                    <a href="find-maids.html" class="block nav-link active" data-page="find-maids" id="mobileFindMaidsLink">Find Maids</a>
                    <a href="find-jobs.html" class="block nav-link" data-page="find-jobs" id="mobileFindJobsLink">Find Jobs</a>
                    <div class="pt-4 border-t border-gray-200">
                        <a href="../auth/login.html" class="block text-gray-700 hover:text-brand-primary font-medium transition-colors mt-4">Sign In</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Profile Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-primary"></div>
            <p class="mt-4 text-lg text-gray-600">Loading profile...</p>
        </div>

        <!-- Profile Content (hidden until loaded) -->
        <div id="profileContent" class="hidden">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <!-- Mobile Profile Header -->
                <div class="md:hidden relative">
                    <img id="profileImageMobile" src="https://via.placeholder.com/600x800?text=No+Image" alt="Maid Profile" 
                        class="w-full h-64 object-cover">
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4">
                        <h1 id="profileName" class="text-2xl font-bold text-white mb-1">Name loading...</h1>
                        <div class="flex items-center text-white text-sm">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            <span id="profileLocation">Location loading...</span>
                        </div>
                    </div>
                </div>

                <div class="md:flex min-h-screen">
                    <!-- Profile Image Section (Desktop) -->
                    <div class="hidden md:block md:w-1/3 sticky top-20 h-[calc(100vh-5rem)]">
                        <div class="relative h-full">
                            <img id="profileImageDesktop" src="https://via.placeholder.com/600x800?text=No+Image" alt="Maid Profile" 
                                class="w-full h-full object-cover">
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-6">
                                <h1 id="profileName" class="text-3xl font-bold text-white mb-2">Name loading...</h1>
                                <div class="flex items-center text-white text-lg">
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                    <span id="profileLocation">Location loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile Details Section -->
                    <div class="md:w-2/3 p-4 md:p-8">
                        <!-- Status Badges -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <div id="profileStatus" class="inline-flex items-center rounded-full bg-green-100 px-3 py-1.5 text-sm font-medium text-green-800">
                                <span class="w-2 h-2 mr-1 rounded-full bg-green-500"></span>
                                Available
                            </div>
                            <div id="profileSalary" class="inline-flex items-center rounded-full bg-brand-light px-3 py-1.5 text-sm font-medium text-brand-primary">
                                <i class="fas fa-money-bill-wave mr-1"></i>
                                Salary loading...
                            </div>
                            <div id="profileWorkType" class="inline-flex items-center rounded-full bg-blue-100 px-3 py-1.5 text-sm font-medium text-blue-800">
                                <i class="fas fa-briefcase mr-1"></i>
                                Work Type loading...
                            </div>
                            <div id="profileWorkingHours" class="inline-flex items-center rounded-full bg-purple-100 px-3 py-1.5 text-sm font-medium text-purple-800">
                                <i class="fas fa-clock mr-1"></i>
                                Hours loading...
                            </div>
                        </div>
                        
                        <!-- Quick Info Grid -->
                        <div class="grid grid-cols-2 gap-3 md:gap-4 mb-6 md:mb-8">
                            <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                                <div class="text-xs sm:text-sm text-gray-500 mb-1">Age Group</div>
                                <div id="profileAge" class="text-base sm:text-lg font-semibold">Loading...</div>
                            </div>
                            <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                                <div class="text-xs sm:text-sm text-gray-500 mb-1">Gender</div>
                                <div id="profileGender" class="text-base sm:text-lg font-semibold">Loading...</div>
                            </div>
                            <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                                <div class="text-xs sm:text-sm text-gray-500 mb-1">Education</div>
                                <div id="profileEducation" class="text-base sm:text-lg font-semibold">Loading...</div>
                            </div>
                            <div class="bg-gray-50 p-3 md:p-4 rounded-lg">
                                <div class="text-xs sm:text-sm text-gray-500 mb-1">Nationality</div>
                                <div id="profileNationality" class="text-base sm:text-lg font-semibold">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- Skills Section -->
                        <div class="mb-6 md:mb-8">
                            <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-tools mr-2 sm:mr-3 text-brand-primary text-xl sm:text-2xl"></i>
                                Skills & Expertise
                            </h2>
                            <div id="profileSkills" class="flex flex-wrap gap-2">
                                <!-- Skills will be added here -->
                            </div>
                        </div>
                        
                        <!-- About Section -->
                        <div class="mb-6 md:mb-8">
                            <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-user mr-2 sm:mr-3 text-brand-primary text-xl sm:text-2xl"></i>
                                About
                            </h2>
                            <p id="profileBio" class="text-gray-700 leading-relaxed text-base sm:text-lg">Bio loading...</p>
                        </div>
                        
                        <!-- Work Details Grid -->
                        <div class="grid md:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
                            <div class="bg-gray-50 p-4 md:p-6 rounded-lg">
                                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-briefcase mr-2 sm:mr-3 text-brand-primary text-xl sm:text-2xl"></i>
                                    Work Preferences
                                </h2>
                                <ul class="space-y-2 md:space-y-3">
                                    <li class="flex items-start">
                                        <span class="text-gray-600 mr-2 w-24 md:w-32 text-xs sm:text-sm">Work Type:</span>
                                        <span id="profileWorkType" class="text-base sm:text-lg font-semibold">Loading...</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-gray-600 mr-2 w-24 md:w-32 text-xs sm:text-sm">Working Hours:</span>
                                        <span id="profileWorkingHours" class="text-base sm:text-lg font-semibold">Loading...</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-gray-600 mr-2 w-24 md:w-32 text-xs sm:text-sm">Working Days:</span>
                                        <span id="profileWorkingDays" class="text-base sm:text-lg font-semibold">Loading...</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-gray-600 mr-2 w-24 md:w-32 text-xs sm:text-sm">Service Type:</span>
                                        <span id="profileServiceType" class="text-base sm:text-lg font-semibold">Loading...</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="bg-gray-50 p-4 md:p-6 rounded-lg">
                                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-language mr-2 sm:mr-3 text-brand-primary text-xl sm:text-2xl"></i>
                                    Languages & Communication
                                </h2>
                                <ul class="space-y-2 md:space-y-3">
                                    <li class="flex items-start">
                                        <span class="text-gray-600 mr-2 w-24 md:w-32 text-xs sm:text-sm">Languages:</span>
                                        <span id="profileLanguages" class="text-base sm:text-lg font-semibold">Loading...</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-gray-600 mr-2 w-24 md:w-32 text-xs sm:text-sm">Experience:</span>
                                        <span id="profileExperience" class="text-base sm:text-lg font-semibold">Loading...</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Contact Section -->
                        <div class="bg-brand-light p-4 md:p-6 rounded-lg">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div>
                                    <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-1">Interested in hiring?</h3>
                                    <p class="text-gray-600 text-sm md:text-base">Get in touch to discuss the opportunity</p>
                                </div>
                                <div class="flex gap-4">
                                    <button id="saveButton" class="w-full md:w-auto bg-green-500 text-white px-6 md:px-8 py-3 rounded-lg hover:bg-green-600 font-semibold transition-colors flex items-center justify-center">
                                        <i class="fas fa-bookmark mr-2"></i>
                                        Save Profile
                                    </button>
                                    <button id="contactButton" class="w-full md:w-auto bg-brand-primary text-white px-6 md:px-8 py-3 rounded-lg hover:bg-brand-secondary font-semibold transition-colors flex items-center justify-center">
                                        <i class="fas fa-phone-alt mr-2"></i>
                                        Contact Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-20">
            <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-medium text-gray-700 mb-2">Profile Not Found</h3>
            <p class="text-gray-500 mb-6">We couldn't find this maid profile. Please make sure you have the correct profile ID in the URL.</p>
            <a href="find-maids.html" class="bg-brand-primary text-white px-6 py-2 rounded-lg hover:bg-brand-secondary font-semibold transition-colors">
                Back to Find Maids
            </a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">City Maid Services</h3>
                    <p class="text-gray-400">Connecting trusted domestic helpers with employers in your area.</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="../index.html" class="text-gray-400 hover:text-white transition-colors">Home</a></li>
                        <li><a href="find-maids.html" class="text-gray-400 hover:text-white transition-colors" id="footerFindMaidsLink">Find Maids</a></li>
                        <li><a href="find-jobs.html" class="text-gray-400 hover:text-white transition-colors" id="footerFindJobsLink">Find Jobs</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Contact</h3>
                    <ul class="space-y-2">
                        <li class="flex items-center text-gray-400">
                            <i class="fas fa-map-marker-alt mr-2"></i> Kathmandu, Nepal
                        </li>
                        <li class="flex items-center text-gray-400">
                            <i class="fas fa-phone mr-2"></i> +977 1234567
                        </li>
                        <li class="flex items-center text-gray-400">
                            <i class="fas fa-envelope mr-2"></i> info@citymaidservices.com
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Follow Us</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fab fa-facebook-f text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fab fa-instagram text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fab fa-linkedin-in text-xl"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; <span id="currentYear"></span> City Maid Services. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://fdgqqxyyofjnkhswkwcq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3FxeHl5b2Zqbmtoc3drd2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjQyMTMsImV4cCI6MjA1OTYwMDIxM30.YyJLLu3r2a7Mh7ny0ie-YzzLfPh5PdrJJHnBFBxWqVE';
        
        // Initialize Supabase client with proper singleton pattern
        const supabaseSingleton = {
            instance: null,
            getInstance: function() {
                if (!this.instance) {
                    console.log('Creating new Supabase client instance');
                    this.instance = supabase.createClient(supabaseUrl, supabaseKey, {
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: true,
                            storageKey: 'citymaid-auth-token',
                            storage: window.localStorage
                        },
                        global: {
                            headers: {
                                'x-application-name': 'citymaid'
                            }
                        }
                    });
                } else {
                    console.log('Using existing Supabase client instance');
                }
                return this.instance;
            }
        };

        // Get the singleton instance
        const supabaseClient = supabaseSingleton.getInstance();

        // Generate avatar URL based on name using UI Avatars instead of Gravatar
        function generateAvatarUrl(name) {
            if (!name) return 'https://ui-avatars.com/api/?name=User&background=4F46E5&color=fff&size=400&bold=true&format=svg';
            const encodedName = encodeURIComponent(name);
            return `https://ui-avatars.com/api/?name=${encodedName}&background=4F46E5&color=fff&size=400&bold=true&format=svg`;
        }

        // Function to get a properly formatted image URL
        async function getImageUrl(profilePhoto) {
            if (!profilePhoto) {
                console.log('No profile photo provided');
                return null;
            }
            
            try {
                console.log('Getting image URL for:', profilePhoto);
                
                // Check if profile_photo is a full URL
                if (profilePhoto.startsWith('http')) {
                    console.log('Profile photo is already a full URL:', profilePhoto);
                    return profilePhoto;
                }

                // Get public URL from maid-profile-photos bucket
                const { data, error } = supabaseClient.storage
                    .from('maid-profile-photos')
                    .getPublicUrl(profilePhoto);
                
                if (!error && data?.publicUrl) {
                    console.log('Got public URL:', data.publicUrl);
                    return data.publicUrl;
                }

                console.error('Failed to get public URL');
                return null;
            } catch (error) {
                console.error('Error in getImageUrl:', error);
                return null;
            }
        }

        // Update the profile image loading logic
        async function loadProfileImage(img, profilePhoto, avatarUrl) {
            try {
                console.log('Starting loadProfileImage function');
                
                // Set avatar as initial fallback
                img.src = avatarUrl;
                
                if (!profilePhoto) {
                    console.log('No profile photo available, using avatar');
                    return;
                }

                // Determine image source
                let imageSource = avatarUrl;
                if (profilePhoto && profilePhoto !== 'null') {
                    try {
                        // Check if profile_photo is a full URL
                        if (profilePhoto.startsWith('http')) {
                            imageSource = profilePhoto;
                        } else {
                            console.log('Getting public URL for profile photo:', profilePhoto);
                            try {
                                // Download the image and convert to base64
                                const { data, error } = await supabaseClient.storage
                                    .from('maid-profile-photos')
                                    .download(profilePhoto);
                                
                                if (!error && data) {
                                    const reader = new FileReader();
                                    reader.onloadend = function() {
                                        const base64data = reader.result;
                                        console.log('Got base64 data');
                                        imageSource = base64data;
                                        
                                        // Update images with base64 data
                                        const mobileImage = document.getElementById('profileImageMobile');
                                        const desktopImage = document.getElementById('profileImageDesktop');
                                        if (mobileImage) mobileImage.src = base64data;
                                        if (desktopImage) desktopImage.src = base64data;
                                    };
                                    reader.readAsDataURL(data);
                                } else {
                                    console.error('Failed to download image:', error);
                                }
                            } catch (error) {
                                console.error('Error downloading image:', error);
                            }
                        }
                    } catch (error) {
                        console.error('Error getting profile photo URL:', error);
                    }
                }

                console.log('Setting image source to:', imageSource);
                img.src = imageSource;
                img.onerror = function() {
                    console.error('Failed to load image, using avatar');
                    img.src = avatarUrl;
                };
            } catch (error) {
                console.error('Error in loadProfileImage:', error);
                img.src = avatarUrl;
            }
        }

        // Global function definitions
        window.selectPlan = async function(planType, maidId) {
            const plans = {
                basic: { price: 500, days: 7, unlocks: 1 },
                standard: { price: 1000, days: 14, unlocks: 3 },
                premium: { price: 1500, days: 21, unlocks: 5 }
            };

            const selectedPlan = plans[planType];
            
            try {
                console.log('Starting mock payment process...');
                console.log('Selected plan:', planType, 'Price:', selectedPlan.price);

                // Show mock payment modal
                showMockPaymentModal(maidId, selectedPlan);
            } catch (error) {
                console.error('Error in payment process:', error);
                showError(`Error processing payment: ${error.message || 'Please try again.'}`);
            }
        };

        window.showMockPaymentModal = function(maidId, plan) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full overflow-hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">Mock Payment</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                                <input type="text" id="mockMobile" class="w-full rounded-md border-gray-300 shadow-sm focus:border-brand-primary focus:ring-brand-primary" 
                                    placeholder="Enter mobile number" value="9800000000">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">PIN</label>
                                <input type="password" id="mockPin" class="w-full rounded-md border-gray-300 shadow-sm focus:border-brand-primary focus:ring-brand-primary" 
                                    placeholder="Enter PIN" value="1234">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">OTP</label>
                                <input type="text" id="mockOtp" class="w-full rounded-md border-gray-300 shadow-sm focus:border-brand-primary focus:ring-brand-primary" 
                                    placeholder="Enter OTP" value="123456">
                            </div>
                            
                            <div class="pt-4">
                                <button onclick="processMockPayment('${maidId}', ${JSON.stringify(plan).replace(/"/g, '&quot;')})" 
                                    class="w-full bg-brand-primary text-white py-3 rounded-lg hover:bg-brand-secondary transition-colors">
                                    Process Payment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        window.processMockPayment = async function(maidId, plan) {
            try {
                // Get current user
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError) throw new Error('Authentication error: ' + sessionError.message);
                if (!session) throw new Error('Please log in to continue');

                const userId = session.user.id;

                // Show loading state
                const modal = document.querySelector('.fixed');
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full overflow-hidden">
                        <div class="p-6 text-center">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-primary mb-4"></div>
                            <p class="text-lg text-gray-600">Processing payment...</p>
                        </div>
                    </div>
                `;

                // Simulate payment processing delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // First check if payment already exists
                const { data: existingPayment, error: checkError } = await supabaseClient
                    .from('payments')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('maid_id', maidId)
                    .eq('status', 'completed')
                    .single();

                if (checkError && checkError.code !== 'PGRST116') { // PGRST116 is "not found" error
                    console.error('Error checking existing payment:', checkError);
                    throw new Error('Error checking payment status');
                }

                // If payment doesn't exist, create it
                if (!existingPayment) {
                    try {
                        // First try with minimal required fields
                        const minimalPaymentData = {
                            user_id: userId,
                            maid_id: maidId,
                            amount: plan.price,
                            status: 'completed',
                            type: 'contact_unlock'
                        };

                        console.log('Attempting to insert payment with minimal data:', minimalPaymentData);

                        const { error: minimalPaymentError } = await supabaseClient
                            .from('payments')
                            .insert(minimalPaymentData);

                        if (minimalPaymentError) {
                            console.error('Minimal payment error:', {
                                message: minimalPaymentError.message,
                                code: minimalPaymentError.code,
                                details: minimalPaymentError.details,
                                hint: minimalPaymentError.hint
                            });

                            // Try with just the essential fields, including all required fields
                            const essentialPaymentData = {
                                user_id: userId,
                                maid_id: maidId,
                                amount: plan.price,
                                status: 'completed',
                                type: 'contact_unlock'
                            };

                            console.log('Attempting to insert payment with essential data:', essentialPaymentData);

                            const { error: essentialPaymentError } = await supabaseClient
                                .from('payments')
                                .insert(essentialPaymentData);

                            if (essentialPaymentError) {
                                console.error('Essential payment error:', {
                                    message: essentialPaymentError.message,
                                    code: essentialPaymentError.code,
                                    details: essentialPaymentError.details,
                                    hint: essentialPaymentError.hint
                                });
                                throw new Error('Failed to record payment: ' + essentialPaymentError.message);
                            }
                        }
                    } catch (error) {
                        console.error('Payment processing error:', error);
                        throw new Error('Failed to record payment: ' + error.message);
                    }
                }

                // Process the unlock
                await processUnlock(maidId, plan);

                // Close the payment modal
                modal.remove();
            } catch (error) {
                console.error('Mock payment error:', error);
                showError(`Payment failed: ${error.message || 'Please try again.'}`);
                
                // Close the modal on error
                const modal = document.querySelector('.fixed');
                if (modal) {
                    modal.remove();
                }
            }
        };

        window.processUnlock = async function(maidId, plan) {
            try {
                // Get current user
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError) throw new Error('Authentication error: ' + sessionError.message);
                if (!session) throw new Error('Please log in to continue');

                const userId = session.user.id;
                console.log('Processing unlock for:', { userId, maidId, plan });

                // Get user role
                const { data: userProfile, error: profileError } = await supabaseClient
                    .from('users')
                    .select('role')
                    .eq('id', userId)
                    .single();

                if (profileError) throw new Error('Error getting user role: ' + profileError.message);
                if (!userProfile) throw new Error('User profile not found');

                const unlockerRole = userProfile.role;
                if (!['employer', 'maid'].includes(unlockerRole)) {
                    throw new Error('Only employers and maids can unlock contacts');
                }

                // Verify payment
                const { data: payment, error: paymentError } = await supabaseClient
                    .from('payments')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('maid_id', maidId)
                    .eq('status', 'completed')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                if (paymentError || !payment) {
                    console.error('Payment verification failed:', paymentError);
                    throw new Error('Payment verification failed. Please try again.');
                }

                // Get maid profile with contact information
                console.log('Starting maid profile search for ID:', maidId);
                
                // First try maid_profiles table with user_id
                console.log('Trying maid_profiles with user_id:', maidId);
                const { data: maidProfiles, error: maidError } = await supabaseClient
                    .from('maid_profiles')
                    .select('*')
                    .eq('user_id', maidId);

                console.log('Maid profiles result:', { data: maidProfiles, error: maidError });

                let maidProfile = null;
                let maidUserId = null;

                if (maidProfiles && maidProfiles.length > 0) {
                    maidProfile = maidProfiles[0];
                    maidUserId = maidId;
                } else {
                    // Try with id field
                    const { data: maidProfileById, error: maidErrorById } = await supabaseClient
                        .from('maid_profiles')
                        .select('*')
                        .eq('id', maidId);

                    if (maidProfileById && maidProfileById.length > 0) {
                        maidProfile = maidProfileById[0];
                        maidUserId = maidProfile.user_id;
                    }
                }

                if (!maidProfile || !maidUserId) {
                    console.error('Profile not found in any table or with any ID field');
                    console.error('Searched maid_profiles with user_id and id, and users_profile with id');
                    throw new Error('Maid profile not found. Please try again or contact support.');
                }

                // Record the unlock
                console.log('Attempting to record unlock with data:', {
                    employer_id: unlockerRole === 'employer' ? userId : maidUserId,
                    maid_id: unlockerRole === 'employer' ? maidUserId : userId,
                    maid_name: maidProfile.full_name,
                    job_title: maidProfile.work_type,
                    maid_location: maidProfile.work_location,
                    unlocker_role: unlockerRole
                });

                try {
                    const { data: unlockData, error: unlockError } = await supabaseClient
                        .from('contact_unlocks')
                        .insert({
                            employer_id: unlockerRole === 'employer' ? userId : maidUserId,
                            maid_id: unlockerRole === 'employer' ? maidUserId : userId,
                            maid_name: maidProfile.full_name,
                            job_title: maidProfile.work_type,
                            maid_location: maidProfile.work_location,
                            unlocker_role: unlockerRole
                        })
                        .select()
                        .single();

                    if (unlockError) {
                        console.error('Error recording unlock:', unlockError);
                        throw new Error('Failed to record unlock. Please try again.');
                    }

                    // Show success message
                    showSuccess('Contact information unlocked successfully!');

                    // Show contact information modal
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full overflow-hidden">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-bold text-gray-900">Contact Information</h2>
                                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${maidProfile.full_name}</h3>
                                        <p class="text-gray-600">${maidProfile.work_type} • ${maidProfile.work_location}</p>
                                    </div>
                                    
                                    <div class="border-t pt-4">
                                        <h4 class="text-sm font-medium text-gray-500 mb-2">Contact Details</h4>
                                        <div class="space-y-3">
                                            <div class="flex items-center">
                                                <i class="fas fa-phone text-brand-primary mr-3"></i>
                                                <span class="text-gray-900">${maidProfile.phone || 'Not provided'}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <i class="fas fa-envelope text-brand-primary mr-3"></i>
                                                <span class="text-gray-900">${maidProfile.email || 'Not provided'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="pt-4">
                                        <button onclick="this.closest('.fixed').remove()" 
                                            class="w-full bg-brand-primary text-white py-3 rounded-lg hover:bg-brand-secondary transition-colors">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    // Update the contact button to show "Contact Unlocked"
                    const contactButton = document.getElementById('contactButton');
                    if (contactButton) {
                        contactButton.disabled = true;
                        contactButton.innerHTML = '<i class="fas fa-check mr-2"></i> Contact Unlocked';
                        contactButton.classList.add('bg-green-500', 'hover:bg-green-600');
                        contactButton.classList.remove('bg-brand-primary', 'hover:bg-brand-secondary');
                    }
                } catch (error) {
                    console.error('Error in unlock process:', error);
                    throw error;
                }
            } catch (error) {
                console.error('Error in unlock process:', error);
                showError(error.message);
            }
        };

        window.showError = function(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-4';
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span>${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(toast);
        };

        window.showSuccess = function(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-4';
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(toast);
        };

        // Sample maid data (fallback if database fetch fails)
        const sampleMaid = {
            id: 1,
            full_name: "Aakriti Sharma",
            work_location: "Kathmandu",
            years_of_experience: 5,
            skills: ["Cooking", "Cleaning", "Laundry"],
            additional_notes: "Experienced in all household duties with a focus on cooking traditional Nepali dishes. I am reliable, punctual, and take pride in my work.",
            expected_salary: 15000,
            gender: "Female",
            age_group: "25",
            education: "SEE",
            work_type: "Full Time",
            languages: ["Nepali", "English", "Hindi"],
            preferred_time: "Morning"
        };

        // Role-based navigation control
        function updateNavigationBasedOnRole() {
            const userRole = localStorage.getItem('userRole');
            
            // Get all navigation elements
            const findMaidsLink = document.getElementById('findMaidsLink');
            const findJobsLink = document.getElementById('findJobsLink');
            const mobileFindMaidsLink = document.getElementById('mobileFindMaidsLink');
            const mobileFindJobsLink = document.getElementById('mobileFindJobsLink');
            const footerFindMaidsLink = document.getElementById('footerFindMaidsLink');
            const footerFindJobsLink = document.getElementById('footerFindJobsLink');
            
            if (userRole === 'maid') {
                // Maids should see Find Jobs but not Find Maids
                if (findMaidsLink) findMaidsLink.classList.add('hidden');
                if (mobileFindMaidsLink) mobileFindMaidsLink.classList.add('hidden');
                if (footerFindMaidsLink) footerFindMaidsLink.classList.add('hidden');
                
                // Highlight Find Jobs as the active link for maids
                if (findJobsLink) {
                    findJobsLink.classList.remove('hidden');
                    findJobsLink.classList.add('active');
                }
                if (mobileFindJobsLink) {
                    mobileFindJobsLink.classList.remove('hidden');
                    mobileFindJobsLink.classList.add('active');
                }
                if (footerFindJobsLink) {
                    footerFindJobsLink.classList.remove('hidden');
                }
                
                // Update the "Back to" link in error state to point to find-jobs.html
                const errorBackLink = document.querySelector('#errorState a');
                if (errorBackLink) {
                    errorBackLink.href = 'find-jobs.html';
                    errorBackLink.textContent = 'Back to Find Jobs';
                }
            } else if (userRole === 'employer') {
                // Employers should see Find Maids but not Find Jobs
                if (findJobsLink) findJobsLink.classList.add('hidden');
                if (mobileFindJobsLink) mobileFindJobsLink.classList.add('hidden');
                if (footerFindJobsLink) footerFindJobsLink.classList.add('hidden');
                
                // Highlight Find Maids as the active link for employers
                if (findMaidsLink) {
                    findMaidsLink.classList.remove('hidden');
                    findMaidsLink.classList.add('active');
                }
                if (mobileFindMaidsLink) {
                    mobileFindMaidsLink.classList.remove('hidden');
                    mobileFindMaidsLink.classList.add('active');
                }
                if (footerFindMaidsLink) {
                    footerFindMaidsLink.classList.remove('hidden');
                }
            }
        }

        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // Mobile menu functionality
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            document.getElementById('mobileMenu').classList.remove('hidden');
        });

        document.getElementById('closeMobileMenu').addEventListener('click', function() {
            document.getElementById('mobileMenu').classList.add('hidden');
        });

        // Generate star rating HTML
        function getStarRating(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let starsHtml = '';
            
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<i class="fas fa-star text-yellow-400"></i>';
            }
            
            // Half star
            if (halfStar) {
                starsHtml += '<i class="fas fa-star-half-alt text-yellow-400"></i>';
            }
            
            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                starsHtml += '<i class="far fa-star text-yellow-400"></i>';
            }
            
            return starsHtml;
        }

        // Get profile ID from URL
        function getProfileIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const profileId = urlParams.get('id');
            
            if (!profileId) {
                // Redirect to find-maids page if no ID is provided
                window.location.href = 'find-maids.html';
                return null;
            }
            
            return profileId;
        }

        // Function to fetch and display maid profile
        async function fetchMaidProfile() {
            try {
                // 1. Check URL and ID
                const urlParams = new URLSearchParams(window.location.search);
                const maidId = urlParams.get('id');
                console.log('1. URL Parameters:', {
                    fullUrl: window.location.href,
                    maidId: maidId
                });
                
                if (!maidId) {
                    console.error('No maid ID provided in URL');
                    window.location.href = 'find-maids.html';
                    return;
                }
            
                // Show loading state
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('profileContent').classList.add('hidden');
                document.getElementById('errorState').classList.add('hidden');

                // 2. Check Supabase connection
                console.log('2. Testing Supabase connection...');
                const { data: testData, error: testError } = await supabaseClient
                    .from('maid_profiles')
                    .select('count')
                    .limit(1);
                
                if (testError) {
                    console.error('Supabase connection error:', testError);
                    throw new Error('Database connection error: ' + testError.message);
                }
                console.log('Supabase connection successful');

                // 3. Check total maid profiles
                console.log('3. Checking total maid profiles...');
                const { count: totalCount, error: countError } = await supabaseClient
                    .from('maid_profiles')
                    .select('*', { count: 'exact', head: true });

                if (countError) {
                    console.error('Error counting profiles:', countError);
                } else {
                    console.log('Total maid profiles in database:', totalCount);
                }

                // 4. Try fetching by ID first
                console.log('4. Attempting to fetch profile by ID:', maidId);
                const { data: maidProfile, error } = await supabaseClient
                    .from('maid_profiles')
                    .select('*')
                    .eq('id', maidId)
                    .maybeSingle();

                if (error) {
                    console.error('Error fetching by ID:', error);
                    console.error('Error details:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    // 5. Try fetching by user_id
                    console.log('5. Attempting to fetch by user_id:', maidId);
                    const { data: profileByUserId, error: userIdError } = await supabaseClient
                        .from('maid_profiles')
                        .select('*')
                        .eq('user_id', maidId)
                        .maybeSingle();

                    if (userIdError) {
                        console.error('Error fetching by user_id:', userIdError);
                        console.error('Error details:', {
                            message: userIdError.message,
                            code: userIdError.code,
                            details: userIdError.details,
                            hint: userIdError.hint
                        });
                        
                        // 6. Try fetching from users_profile table
                        console.log('6. Attempting to fetch from users_profile table...');
                        const { data: userProfile, error: userProfileError } = await supabaseClient
                            .from('users_profile')
                            .select('*')
                            .eq('id', maidId)
                            .maybeSingle();

                        if (userProfileError) {
                            console.error('Error fetching from users_profile:', userProfileError);
                            console.error('Error details:', {
                                message: userProfileError.message,
                                code: userProfileError.code,
                                details: userProfileError.details,
                                hint: userProfileError.hint
                            });
                            throw new Error('Profile not found in any table. Please verify the ID.');
                        }

                        if (!userProfile) {
                            console.error('No profile found in users_profile');
                            throw new Error('Profile not found in any table. Please verify the ID.');
                        }

                        console.log('Found profile in users_profile:', userProfile);
                        displayProfile(userProfile);
                        return;
                    }

                    if (!profileByUserId) {
                        console.error('No profile found with user_id');
                        throw new Error('Profile not found. Please verify the ID.');
                    }

                    console.log('Found profile using user_id:', profileByUserId);
                    displayProfile(profileByUserId);
                    return;
                }

                if (!maidProfile) {
                    console.error('No profile found with id');
                    throw new Error('Profile not found. Please verify the ID.');
                }

                console.log('Found profile using id:', maidProfile);
                console.log('Profile details:', {
                    id: maidProfile.id,
                    user_id: maidProfile.user_id,
                    full_name: maidProfile.full_name,
                    profile_photo: maidProfile.profile_photo,
                    work_location: maidProfile.work_location,
                    work_type: maidProfile.work_type,
                    service_type: maidProfile.service_type,
                    working_hours: maidProfile.working_hours,
                    preferred_time: maidProfile.preferred_time,
                    expected_salary: maidProfile.expected_salary,
                    experience: maidProfile.experience,
                    years_of_experience: maidProfile.years_of_experience,
                    additional_notes: maidProfile.additional_notes,
                    is_active: maidProfile.is_active,
                    created_at: maidProfile.created_at,
                    updated_at: maidProfile.updated_at
                });

                // Update experience display
                const experienceElement = document.getElementById('profileExperience');
                if (experienceElement) {
                    let experienceText = 'Not specified';
                    if (maidProfile.experience) {
                        experienceText = maidProfile.experience;
                    } else if (maidProfile.years_of_experience) {
                        experienceText = `${maidProfile.years_of_experience} years`;
                    } else if (maidProfile.additional_notes) {
                        // Try to extract experience from additional notes if available
                        const experienceMatch = maidProfile.additional_notes.match(/(\d+)\s*(?:years?|yrs?)\s*(?:of)?\s*experience/i);
                        if (experienceMatch) {
                            experienceText = `${experienceMatch[1]} years`;
                        }
                    }
                    experienceElement.textContent = experienceText;
                }

                // Update work type display
                const workTypeElements = document.querySelectorAll('[id="profileWorkType"]');
                workTypeElements.forEach(element => {
                    let workTypeText = 'Not specified';
                    if (maidProfile.work_type) {
                        workTypeText = maidProfile.work_type;
                    } else if (maidProfile.service_type) {
                        workTypeText = maidProfile.service_type;
                    }
                    if (element.classList.contains('inline-flex')) {
                        // For badge display
                        element.innerHTML = `<i class="fas fa-briefcase mr-1"></i>${workTypeText}`;
                    } else {
                        // For text display
                        element.textContent = workTypeText;
                    }
                });

                // Update working hours display
                const workingHoursElements = document.querySelectorAll('[id="profileWorkingHours"]');
                workingHoursElements.forEach(element => {
                    let hoursText = 'Not specified';
                    if (maidProfile.working_hours) {
                        hoursText = maidProfile.working_hours;
                    } else if (maidProfile.preferred_time) {
                        hoursText = maidProfile.preferred_time;
                    }
                    if (element.classList.contains('inline-flex')) {
                        // For badge display
                        element.innerHTML = `<i class="fas fa-clock mr-1"></i>${hoursText}`;
                    } else {
                        // For text display
                        element.textContent = hoursText;
                    }
                });

                displayProfile(maidProfile);

                // After displaying profile, check saved status
                await checkSavedStatus();

            } catch (error) {
                console.error('Error in fetchMaidProfile:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                
                // Update error message with more details
                const errorMessage = document.querySelector('#errorState p');
                if (errorMessage) {
                    errorMessage.textContent = `We couldn't find this maid profile. ${error.message}`;
                }
            }
        }

        // Function to display profile data
        async function displayProfile(maidProfile) {
            try {
                console.log('Starting displayProfile function');
                console.log('Maid profile data:', maidProfile);
                console.log('Profile photo path:', maidProfile.profile_photo);

                // Generate avatar URL based on name
                const avatarUrl = generateAvatarUrl(maidProfile.full_name);
                console.log('Generated avatar URL:', avatarUrl);
                
                // Determine image source
                let imageSource = avatarUrl;
                if (maidProfile.profile_photo && maidProfile.profile_photo !== 'null') {
                    try {
                        // Check if profile_photo is a full URL
                        if (maidProfile.profile_photo.startsWith('http')) {
                            imageSource = maidProfile.profile_photo;
                        } else {
                            // Get public URL from maid-profile-photos bucket
                            const { data, error } = supabaseClient.storage
                                .from('maid-profile-photos')
                                .getPublicUrl(maidProfile.profile_photo);
                            
                            if (!error && data?.publicUrl) {
                                imageSource = data.publicUrl;
                            }
                        }
                    } catch (error) {
                        console.error('Error getting profile photo URL:', error);
                    }
                }

                console.log('Final image source:', imageSource);

                // Update mobile image
                const mobileImage = document.getElementById('profileImageMobile');
                if (mobileImage) {
                    mobileImage.src = imageSource;
                    mobileImage.onerror = function() {
                        console.error('Mobile image failed to load, using avatar');
                        mobileImage.src = avatarUrl;
                    };
                }

                // Update desktop image
                const desktopImage = document.getElementById('profileImageDesktop');
                if (desktopImage) {
                    desktopImage.src = imageSource;
                    desktopImage.onerror = function() {
                        console.error('Desktop image failed to load, using avatar');
                        desktopImage.src = avatarUrl;
                    };
                }

                // Update basic info
                document.getElementById('profileName').textContent = maidProfile.full_name || 'No Name';
                document.getElementById('profileLocation').textContent = maidProfile.work_location || 'Location not specified';
                
                // Update status badges
                document.getElementById('profileStatus').innerHTML = maidProfile.is_active ? 
                    `<span class="w-2 h-2 mr-1 rounded-full bg-green-500"></span>Available` :
                    `<span class="w-2 h-2 mr-1 rounded-full bg-red-500"></span>Not Available`;
                
                document.getElementById('profileSalary').innerHTML = 
                    `<i class="fas fa-money-bill-wave mr-1"></i>₹${maidProfile.expected_salary || 0}/month`;
                
                document.getElementById('profileWorkType').innerHTML = 
                    `<i class="fas fa-briefcase mr-1"></i>${maidProfile.work_type || 'Not specified'}`;
                
                document.getElementById('profileWorkingHours').innerHTML = 
                    `<i class="fas fa-clock mr-1"></i>${maidProfile.working_hours || 'Not specified'}`;

                // Update quick info
                document.getElementById('profileAge').textContent = maidProfile.age_group || 'Not specified';
                document.getElementById('profileGender').textContent = maidProfile.gender || 'Not specified';
                document.getElementById('profileEducation').textContent = maidProfile.education || 'Not specified';
                document.getElementById('profileNationality').textContent = maidProfile.nationality || 'Not specified';

                // Update skills
                const skillsContainer = document.getElementById('profileSkills');
                skillsContainer.innerHTML = maidProfile.skills ? 
                    maidProfile.skills.map(skill => `
                        <span class="inline-flex items-center rounded-full bg-brand-light px-3 py-1.5 text-xs font-medium text-brand-primary">
                            ${skill}
                        </span>
                    `).join('') : 'No skills specified';

                // Update about section
                document.getElementById('profileBio').textContent = maidProfile.about || 'No description provided';

                // Update work preferences
                document.getElementById('profileWorkType').textContent = maidProfile.work_type || 'Not specified';
                document.getElementById('profileWorkingHours').textContent = maidProfile.working_hours || 'Not specified';
                document.getElementById('profileWorkingDays').textContent = maidProfile.working_days || 'Not specified';
                document.getElementById('profileServiceType').textContent = maidProfile.service_type || 'Not specified';

                // Update languages and communication
                document.getElementById('profileLanguages').textContent = maidProfile.language || 'Not specified';
                document.getElementById('profileExperience').textContent = maidProfile.experience || 'Not specified';

                // Show profile content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('profileContent').classList.remove('hidden');
            } catch (error) {
                console.error('Error displaying profile:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            fetchMaidProfile();
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Add save button event listener
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.addEventListener('click', handleSaveProfile);
            }
        });

        // Handle saving profile
        async function handleSaveProfile() {
            try {
                // Check if user is logged in
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !session) {
                    showError('Please log in to save profiles');
                    return;
                }

                const userId = session.user.id;
                const maidId = getProfileIdFromUrl();

                if (!maidId) {
                    showError('Invalid profile ID');
                    return;
                }

                // Check if profile is already saved
                const { data: existingSave, error: checkError } = await supabaseClient
                    .from('saved_profiles')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('maid_id', maidId)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') { // PGRST116 is "not found" error
                    throw new Error('Error checking saved status');
                }

                if (existingSave) {
                    // Unsave the profile
                    const { error: deleteError } = await supabaseClient
                        .from('saved_profiles')
                        .delete()
                        .eq('id', existingSave.id);

                    if (deleteError) throw deleteError;

                    // Update button state
                    const saveButton = document.getElementById('saveButton');
                    saveButton.innerHTML = '<i class="fas fa-bookmark mr-2"></i> Save Profile';
                    saveButton.classList.remove('bg-green-600');
                    saveButton.classList.add('bg-green-500');
                    showSuccess('Profile unsaved successfully');
                } else {
                    // Save the profile
                    const { error: saveError } = await supabaseClient
                        .from('saved_profiles')
                        .insert({
                            user_id: userId,
                            maid_id: maidId,
                            saved_at: new Date().toISOString()
                        });

                    if (saveError) throw saveError;

                    // Update button state
                    const saveButton = document.getElementById('saveButton');
                    saveButton.innerHTML = '<i class="fas fa-check mr-2"></i> Saved';
                    saveButton.classList.remove('bg-green-500');
                    saveButton.classList.add('bg-green-600');
                    showSuccess('Profile saved successfully');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showError('Error saving profile: ' + error.message);
            }
        }

        // Check if profile is saved on load
        async function checkSavedStatus() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) return;

                const userId = session.user.id;
                const maidId = getProfileIdFromUrl();

                if (!maidId) return;

                const { data: savedProfile, error } = await supabaseClient
                    .from('saved_profiles')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('maid_id', maidId)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error checking saved status:', error);
                    return;
                }

                if (savedProfile) {
                    const saveButton = document.getElementById('saveButton');
                    if (saveButton) {
                        saveButton.innerHTML = '<i class="fas fa-check mr-2"></i> Saved';
                        saveButton.classList.remove('bg-green-500');
                        saveButton.classList.add('bg-green-600');
                    }
                }
            } catch (error) {
                console.error('Error checking saved status:', error);
            }
        }
    </script>
</body>
</html> 