<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maid Dashboard - City Maid Services</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            primary: '#4F46E5',
                            secondary: '#4338CA',
                            light: '#EEF2FF',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-poppins bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex items-center">
                    <a href="../index.html" class="text-3xl font-bold text-brand-primary tracking-tight">City<span class="text-brand-secondary"> Maid</span></a>
                </div>
                <!-- Desktop menu -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="../index.html" class="text-gray-700 hover:text-brand-primary font-medium transition-colors">Home</a>
                    <a href="../jobs/find-jobs.html" class="text-gray-700 hover:text-brand-primary font-medium transition-colors">Find Jobs</a>
                    <div class="relative group">
                        <button id="userMenuBtn" class="flex items-center space-x-2 text-brand-primary">
                            <i class="fas fa-user-circle text-2xl"></i>
                            <span class="font-medium">My Account</span>
                        </button>
                        <div class="hidden group-hover:block absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg">
                            <a href="dashboard.html" class="block px-4 py-2 hover:bg-gray-100 text-brand-primary">Dashboard</a>
                            <a href="profile.html" class="block px-4 py-2 hover:bg-gray-100">Profile</a>
                            <a href="#" id="signOutBtn" class="block px-4 py-2 hover:bg-gray-100">Sign Out</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900" id="welcomeHeading">Welcome to your Dashboard</h1>
                    <p class="text-gray-600 mt-1" id="profileCompletionMessage">Complete your profile to start receiving job inquiries</p>
                </div>
                <div class="flex space-x-4">
                    <a href="profile.html" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-brand-primary hover:bg-brand-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary">
                        <i class="fas fa-user-edit mr-2"></i>
                        Update Profile
                    </a>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Profile Status Card -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">Profile Status</h2>
                    <span id="profileStatus" class="px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Incomplete</span>
                </div>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Profile Visibility</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="profileVisibilityToggle" class="sr-only peer" aria-label="Toggle profile visibility">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-primary"></div>
                        </label>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Availability Status</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="availabilityToggle" class="sr-only peer" aria-label="Toggle availability status">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </div>
                    <div class="pt-2">
                        <a href="profile.html" class="text-brand-primary hover:text-brand-secondary text-sm font-medium">
                            Complete your profile <i class="fas fa-arrow-right ml-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recent Jobs Card -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Job Inquiries</h2>
                <div id="recentJobsContainer">
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No inquiries yet</p>
                        <p class="text-sm text-gray-400 mt-1">Complete your profile to start receiving inquiries</p>
                    </div>
                </div>
            </div>

            <!-- Account Statistics Card -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Account Statistics</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-3 bg-brand-light rounded-lg">
                        <p class="text-sm text-gray-600">Profile Views</p>
                        <p class="text-2xl font-bold text-brand-primary">0</p>
                    </div>
                    <div class="p-3 bg-brand-light rounded-lg">
                        <p class="text-sm text-gray-600">Jobs Applied</p>
                        <p class="text-2xl font-bold text-brand-primary">0</p>
                    </div>
                    <div class="p-3 bg-brand-light rounded-lg">
                        <p class="text-sm text-gray-600">Jobs Completed</p>
                        <p class="text-2xl font-bold text-brand-primary">0</p>
                    </div>
                    <div class="p-3 bg-brand-light rounded-lg">
                        <p class="text-sm text-gray-600">Rating</p>
                        <p class="text-2xl font-bold text-brand-primary">N/A</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Recent Activity</h2>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-6 text-center">
                    <i class="fas fa-clock text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No recent activity</p>
                    <p class="text-sm text-gray-400 mt-1">Your recent activities will appear here</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://fdgqqxyyofjnkhswkwcq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3FxeHl5b2Zqbmtoc3drd2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjQyMTMsImV4cCI6MjA1OTYwMDIxM30.YyJLLu3r2a7Mh7ny0ie-YzzLfPh5PdrJJHnBFBxWqVE';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentProfile = null;

        // Check session and load profile
        async function initializeDashboard() {
            try {
                // Verify that user has the correct role for this page
                const userRole = localStorage.getItem('userRole');
                if (userRole !== 'maid') {
                    // Redirect employers to their dashboard
                    if (userRole === 'employer') {
                        window.location.href = '../employer/dashboard.html';
                        return;
                    }
                    
                    // Set role to maid if not set or invalid
                    localStorage.setItem('userRole', 'maid');
                }
                
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError) throw sessionError;
                
                if (!session) {
                    window.location.href = '../auth/login.html?type=maid';
                    return;
                }

                currentUser = session.user;
                await loadProfile();
                updateUIWithProfileData();
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showError('Error loading dashboard. Please try again.');
            }
        }

        // Load existing profile data
        async function loadProfile() {
            try {
                const { data: profile, error } = await supabaseClient
                    .from('maid_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                currentProfile = profile || null;
                return profile;
            } catch (error) {
                console.error('Error loading profile:', error);
                showError('Error loading profile data. Please try again.');
                return null;
            }
        }

        // Update UI with profile data
        function updateUIWithProfileData() {
            // Update welcome message
            const welcomeHeading = document.getElementById('welcomeHeading');
            const profileCompletionMessage = document.getElementById('profileCompletionMessage');
            const profileStatus = document.getElementById('profileStatus');
            const profileVisibilityToggle = document.getElementById('profileVisibilityToggle');
            const availabilityToggle = document.getElementById('availabilityToggle');

            if (currentProfile) {
                welcomeHeading.textContent = `Welcome, ${currentProfile.full_name || 'Maid'}!`;
                
                // Update profile completion message
                if (isProfileComplete()) {
                    profileCompletionMessage.textContent = 'Your profile is complete and ready to be viewed by employers';
                    profileStatus.textContent = 'Complete';
                    profileStatus.classList.remove('bg-yellow-100', 'text-yellow-800');
                    profileStatus.classList.add('bg-green-100', 'text-green-800');
                } else {
                    profileCompletionMessage.textContent = 'Complete your profile to increase your chances of finding jobs';
                    profileStatus.textContent = 'Incomplete';
                }

                // Set toggle states
                if (profileVisibilityToggle) {
                    profileVisibilityToggle.checked = currentProfile.status === 'active';
                }
                
                if (availabilityToggle) {
                    availabilityToggle.checked = currentProfile.is_available !== false; // Default to true if not set
                }

                // Add event listeners to toggles
                if (profileVisibilityToggle) {
                    profileVisibilityToggle.addEventListener('change', toggleProfileVisibility);
                }
                
                if (availabilityToggle) {
                    availabilityToggle.addEventListener('change', toggleAvailability);
                }
            } else {
                welcomeHeading.textContent = 'Welcome to your Dashboard';
                profileCompletionMessage.textContent = 'Please complete your profile to start receiving job inquiries';
                profileStatus.textContent = 'Not Started';
                profileStatus.classList.remove('bg-green-100', 'text-green-800');
                profileStatus.classList.add('bg-red-100', 'text-red-800');
            }
        }

        // Check if profile is complete
        function isProfileComplete() {
            if (!currentProfile) return false;
            
            const requiredFields = [
                'full_name', 'age_group', 'gender', 'marital_status', 
                'nationality', 'education', 'email', 'phone', 
                'address', 'emergency_contact', 'work_type', 
                'expected_salary', 'work_location', 'skills', 
                'languages', 'additional_notes'
            ];
            
            return requiredFields.every(field => {
                if (Array.isArray(currentProfile[field])) {
                    return currentProfile[field].length > 0;
                }
                return currentProfile[field] !== null && currentProfile[field] !== undefined && currentProfile[field] !== '';
            });
        }

        // Add profile visibility toggle functionality
        async function toggleProfileVisibility() {
            try {
                if (!currentProfile) {
                    showError('Please complete your profile first');
                    this.checked = false;
                    return;
                }

                const toggle = document.getElementById('profileVisibilityToggle');
                if (!toggle) return;

                // Show loading state
                toggle.disabled = true;

                const newStatus = this.checked ? 'active' : 'inactive';
                const { error } = await supabaseClient
                    .from('maid_profiles')
                    .update({ status: newStatus })
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                currentProfile.status = newStatus;
                toggle.disabled = false;

                showSuccess(`Profile is now ${newStatus === 'active' ? 'public' : 'private'}`);
            } catch (error) {
                console.error('Error toggling profile visibility:', error);
                
                // Restore toggle state
                const toggle = document.getElementById('profileVisibilityToggle');
                if (toggle) {
                    toggle.checked = currentProfile?.status === 'active';
                    toggle.disabled = false;
                }

                showError(`Failed to update profile visibility: ${error.message}`);
            }
        }
        
        // Add availability toggle functionality
        async function toggleAvailability() {
            try {
                if (!currentProfile) {
                    showError('Please complete your profile first');
                    this.checked = false;
                    return;
                }

                const toggle = document.getElementById('availabilityToggle');
                if (!toggle) return;

                // Show loading state
                toggle.disabled = true;

                const newAvailability = this.checked;
                const { error } = await supabaseClient
                    .from('maid_profiles')
                    .update({ is_available: newAvailability })
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                currentProfile.is_available = newAvailability;
                toggle.disabled = false;

                showSuccess(`You are now marked as ${newAvailability ? 'available' : 'engaged'}`);
            } catch (error) {
                console.error('Error toggling availability:', error);
                
                // Restore toggle state
                const toggle = document.getElementById('availabilityToggle');
                if (toggle) {
                    toggle.checked = currentProfile?.is_available !== false;
                    toggle.disabled = false;
                }

                showError(`Failed to update availability status: ${error.message}`);
            }
        }

        // Handle sign out
        document.getElementById('signOutBtn').addEventListener('click', async function() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                window.location.href = '../index.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showError('Error signing out. Please try again.');
            }
        });

        // Show success message
        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
            alert.innerHTML = `
                <span class="block sm:inline">${message}</span>
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        // Show error message
        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
            alert.innerHTML = `
                <span class="block sm:inline">${message}</span>
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html> 