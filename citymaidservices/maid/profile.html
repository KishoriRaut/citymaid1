<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Your Profile - City Maid Services</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Helvetica Neue', 'Segoe UI', 'Inter', 'sans-serif'],
                    },
                    colors: {
                        whatsapp: {
                            primary: '#25D366',    // WhatsApp Green
                            secondary: '#128C7E',  // WhatsApp Teal
                            dark: '#075E54',       // WhatsApp Dark Green
                            light: '#F0F2F5',      // WhatsApp Background
                            text: {
                                primary: '#111B21',   // WhatsApp Dark Text
                                secondary: '#667781', // WhatsApp Secondary Text
                                light: '#FFFFFF',     // White text
                            }
                        }
                    },
                    boxShadow: {
                        'whatsapp': '0 1px 3px rgba(0, 0, 0, 0.1)',
                        'whatsapp-hover': '0 2px 4px rgba(0, 0, 0, 0.15)',
                    },
                    borderRadius: {
                        'whatsapp': '8px',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="font-sans bg-whatsapp-light text-whatsapp-text-primary">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-whatsapp sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="../index.html" class="text-2xl font-semibold text-whatsapp-primary">CITYMAID</a>
                </div>
                <!-- Desktop menu -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="../index.html" class="text-whatsapp-text-primary hover:text-whatsapp-primary transition-colors">
                        <i class="fas fa-home mr-1"></i> Home
                    </a>
                    <div class="relative">
                        <button id="userMenuBtn" class="flex items-center space-x-2 text-whatsapp-text-primary hover:text-whatsapp-primary transition-colors">
                            <i class="fas fa-user-circle text-2xl"></i>
                            <span class="font-medium" id="user-role-display">My Account</span>
                        </button>
                        <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-whatsapp shadow-whatsapp border border-gray-200">
                            <a href="dashboard.html" class="block px-4 py-2 hover:bg-whatsapp-light text-whatsapp-primary transition-colors">Dashboard</a>
                            <a href="profile.html" class="block px-4 py-2 hover:bg-whatsapp-light transition-colors">Profile</a>
                            <a href="#" id="signOutBtn" class="block px-4 py-2 hover:bg-whatsapp-light transition-colors">Sign Out</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Profile Update Form -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-whatsapp shadow-whatsapp p-6 md:p-8 border border-gray-100">
            <h1 class="text-2xl font-semibold text-whatsapp-text-primary mb-8 pb-4 border-b border-gray-200">Update Your Profile</h1>
            
            <form id="profileForm" class="space-y-8">
                <!-- Profile Photo -->
                <div class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-whatsapp-text-primary">Profile Photo *</label>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <div class="w-32 h-32 rounded-full bg-white flex items-center justify-center overflow-hidden border-2 border-whatsapp-primary">
                                <img id="profilePhotoPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150' fill='none'%3E%3Crect width='150' height='150' fill='%23F0F2F5'/%3E%3Cpath d='M75 75C83.2843 75 90 68.2843 90 60C90 51.7157 83.2843 45 75 45C66.7157 45 60 51.7157 60 60C60 68.2843 66.7157 75 75 75Z' fill='%23667781'/%3E%3Cpath d='M75 82.5C58.4315 82.5 45 95.9315 45 112.5V120H105V112.5C105 95.9315 91.5685 82.5 75 82.5Z' fill='%23667781'/%3E%3C/svg%3E" alt="Profile Photo" 
                                    class="w-32 h-32 object-cover">
                                <i id="placeholderIcon" class="fas fa-user-circle text-whatsapp-text-secondary text-5xl absolute"></i>
                            </div>
                            <input type="file" id="profilePhoto" accept="image/*" class="hidden" title="Upload profile photo">
                            <button type="button" onclick="document.getElementById('profilePhoto').click()" 
                                class="absolute bottom-0 right-0 bg-whatsapp-primary text-white p-2 rounded-full hover:bg-whatsapp-secondary transition-colors" title="Upload photo">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        <div>
                            <button type="button" onclick="document.getElementById('profilePhoto').click()" 
                                class="bg-whatsapp-primary text-white px-4 py-2 rounded-whatsapp hover:bg-whatsapp-secondary transition-colors">
                                Change Photo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="space-y-6">
                    <h2 class="text-lg font-semibold text-whatsapp-text-primary">Personal Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="fullName" class="block text-sm font-medium text-whatsapp-text-primary">Full Name *</label>
                            <input type="text" id="fullName" name="fullName" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="ageGroup" class="block text-sm font-medium text-whatsapp-text-primary">Age Group *</label>
                            <select id="ageGroup" name="ageGroup" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Age Group</option>
                                <option value="18-25">18-25</option>
                                <option value="26-35">26-35</option>
                                <option value="36-45">36-45</option>
                                <option value="46-55">46-55</option>
                                <option value="56+">56+</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="gender" class="block text-sm font-medium text-whatsapp-text-primary">Gender *</label>
                            <select id="gender" name="gender" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Gender</option>
                                <option value="Female">Female</option>
                                <option value="Male">Male</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="maritalStatus" class="block text-sm font-medium text-whatsapp-text-primary">Marital Status *</label>
                            <select id="maritalStatus" name="maritalStatus" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Status</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Divorced">Divorced</option>
                                <option value="Widowed">Widowed</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="nationality" class="block text-sm font-medium text-whatsapp-text-primary">Nationality *</label>
                            <select id="nationality" name="nationality" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Nationality</option>
                                <option value="Nepali">Nepali</option>
                                <option value="Indian">Indian</option>
                                <option value="Chinese">Chinese</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="religion" class="block text-sm font-medium text-whatsapp-text-primary">Religion</label>
                            <select id="religion" name="religion"
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Religion</option>
                                <option value="Hindu">Hindu</option>
                                <option value="Buddhist">Buddhist</option>
                                <option value="Muslim">Muslim</option>
                                <option value="Christian">Christian</option>
                                <option value="Kirat">Kirat</option>
                                <option value="Jain">Jain</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="education" class="block text-sm font-medium text-whatsapp-text-primary">Education Level *</label>
                            <select id="education" name="education" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Education Level</option>
                                <option value="Under SEE">Under SEE</option>
                                <option value="SEE">SEE</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Bachelor">Bachelor</option>
                                <option value="Master">Master</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="space-y-6">
                    <h2 class="text-lg font-semibold text-whatsapp-text-primary">Contact Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="phone" class="block text-sm font-medium text-whatsapp-text-primary">Phone Number *</label>
                            <input type="tel" id="phone" name="phone" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="email" class="block text-sm font-medium text-whatsapp-text-primary">Email Address *</label>
                            <input type="email" id="email" name="email" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="address" class="block text-sm font-medium text-whatsapp-text-primary">Address *</label>
                            <input type="text" id="address" name="address" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="emergencyContact" class="block text-sm font-medium text-whatsapp-text-primary">Emergency Contact *</label>
                            <input type="tel" id="emergencyContact" name="emergencyContact" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                        </div>
                    </div>
                </div>

                <!-- Work Information -->
                <div class="space-y-6">
                    <h2 class="text-lg font-semibold text-whatsapp-text-primary">Work Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="experience" class="block text-sm font-medium text-whatsapp-text-primary">Years of Experience *</label>
                            <input type="number" id="experience" name="experience" min="0" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="workType" class="block text-sm font-medium text-whatsapp-text-primary">Work Type *</label>
                            <select id="workType" name="workType" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Work Type</option>
                                <option value="Full Time">Full Time</option>
                                <option value="Part Time">Part Time</option>
                                <option value="Live In">Live In</option>
                                <option value="Live Out">Live Out</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="preferredTime" class="block text-sm font-medium text-whatsapp-text-primary">Preferred Working Time *</label>
                            <select id="preferredTime" name="preferredTime" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Preferred Time</option>
                                <option value="Morning">Morning Time</option>
                                <option value="Day">Day Time</option>
                                <option value="Evening">Evening Time</option>
                                <option value="Night">Night Time</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="salary" class="block text-sm font-medium text-whatsapp-text-primary">Expected Salary (NR) *</label>
                            <input type="number" id="salary" name="salary" min="0" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="workLocation" class="block text-sm font-medium text-whatsapp-text-primary">Work Location *</label>
                            <input type="text" id="workLocation" name="workLocation" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                        </div>
                    </div>
                </div>

                <!-- Skills -->
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-whatsapp-text-primary">Skills * (Select all that apply)</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="skill-checkbox" value="Cooking" name="skills">
                            <span>Cooking</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="skill-checkbox" value="Cleaning" name="skills">
                            <span>Cleaning</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="skill-checkbox" value="Laundry" name="skills">
                            <span>Laundry</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="skill-checkbox" value="Child Care" name="skills">
                            <span>Child Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="skill-checkbox" value="Elderly Care" name="skills">
                            <span>Elderly Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="skill-checkbox" value="Patient Care" name="skills">
                            <span>Patient Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="skill-checkbox" value="Pet Care" name="skills">
                            <span>Pet Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="skill-checkbox" value="Postnatal/Sutkeri Care" name="skills">
                            <span>Postnatal/Sutkeri Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="skill-checkbox" value="Office Assistant" name="skills">
                            <span>Office Assistant</span>
                        </label>
                    </div>
                </div>

                <!-- Languages -->
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-whatsapp-text-primary">Languages * (Select all that apply)</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="language-checkbox" value="Nepali" name="languages">
                            <span>Nepali</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="language-checkbox" value="English" name="languages">
                            <span>English</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="language-checkbox" value="Hindi" name="languages">
                            <span>Hindi</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="language-checkbox" value="Newari" name="languages">
                            <span>Newari</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="language-checkbox" value="Tamang" name="languages">
                            <span>Tamang</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="language-checkbox" value="Gurung" name="languages">
                            <span>Gurung</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="language-checkbox" value="Magar" name="languages">
                            <span>Magar</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="language-checkbox" value="Tharu" name="languages">
                            <span>Tharu</span>
                        </label>
                    </div>
                </div>

                <!-- About Me -->
                <div class="space-y-4">
                    <label for="about" class="block text-sm font-medium text-whatsapp-text-primary">Additional Notes *</label>
                    <textarea id="about" name="about" rows="4" required
                        class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary"
                        placeholder="Tell us about yourself, your experience, and what makes you a great domestic helper"></textarea>
                </div>

                <!-- Profile Status -->
                <div class="space-y-4">
                    <h2 class="text-lg font-semibold text-whatsapp-text-primary">Profile Status</h2>
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h3 class="font-medium text-whatsapp-text-primary">Profile Visibility</h3>
                            <p class="text-sm text-whatsapp-text-secondary">Toggle to make your profile visible or hidden to employers</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="profileVisibilityToggle" class="sr-only peer" aria-label="Toggle profile visibility">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-whatsapp-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-whatsapp-primary"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h3 class="font-medium text-whatsapp-text-primary">Availability Status</h3>
                            <p class="text-sm text-whatsapp-text-secondary">Mark yourself as available or engaged</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="availabilityToggle" class="sr-only peer" aria-label="Toggle availability status">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-whatsapp-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" class="bg-whatsapp-primary text-white px-6 py-3 rounded-whatsapp hover:bg-whatsapp-secondary transition-colors">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-whatsapp shadow-whatsapp hidden">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMessage"></span>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed bottom-4 right-4 bg-whatsapp-primary text-white px-6 py-3 rounded-whatsapp shadow-whatsapp hidden">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successMessage"></span>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://fdgqqxyyofjnkhswkwcq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3FxeHl5b2Zqbmtoc3drd2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjQyMTMsImV4cCI6MjA1OTYwMDIxM30.YyJLLu3r2a7Mh7ny0ie-YzzLfPh5PdrJJHnBFBxWqVE';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentProfile = null;

        // Load profile data with RLS handling
        async function loadProfile() {
            try {
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError) throw sessionError;
                
                if (!session) {
                    window.location.href = '../auth/login.html?role=maid';
                    return;
                }

                currentUser = session.user;
                
                // Check if user has maid role
                const { data: userRole, error: roleError } = await supabaseClient
                    .from('user_roles')
                    .select('role')
                    .eq('user_id', currentUser.id)
                    .single();

                if (roleError || !userRole || userRole.role !== 'maid') {
                    showError('Unauthorized access. Only maids can access this page.');
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 3000);
                    return;
                }

                // Load profile with RLS
                const { data: profile, error: profileError } = await supabaseClient
                    .from('maid_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (profileError) {
                    if (profileError.code === 'PGRST116') {
                        showError('Profile not found. Please create a profile first.');
                        setTimeout(() => {
                            window.location.href = 'create-profile.html';
                        }, 3000);
                    } else {
                        throw profileError;
                    }
                    return;
                }

                currentProfile = profile;
                populateForm(profile);
            } catch (error) {
                console.error('Error loading profile:', error);
                showError('Error loading profile. Please try again.');
            }
        }

        // Populate form with profile data
        function populateForm(profile) {
            document.getElementById('fullName').value = profile.full_name || '';
            document.getElementById('ageGroup').value = profile.age_group || '';
            document.getElementById('gender').value = profile.gender || '';
            document.getElementById('maritalStatus').value = profile.marital_status || '';
            document.getElementById('nationality').value = profile.nationality || '';
            document.getElementById('religion').value = profile.religion || '';
            document.getElementById('education').value = profile.education || '';
            document.getElementById('email').value = profile.email || '';
            document.getElementById('phone').value = profile.phone || '';
            document.getElementById('address').value = profile.address || '';
            document.getElementById('emergencyContact').value = profile.emergency_contact || '';
            document.getElementById('experience').value = profile.years_of_experience || '';
            document.getElementById('workType').value = profile.work_type || '';
            document.getElementById('preferredTime').value = profile.preferred_time || '';
            document.getElementById('salary').value = profile.expected_salary || '';
            document.getElementById('workLocation').value = profile.work_location || '';
            document.getElementById('about').value = profile.additional_notes || '';

            if (profile.profile_photo) {
                document.getElementById('profilePhotoPreview').src = profile.profile_photo;
                document.getElementById('placeholderIcon').classList.add('hidden');
            }

            // Set skills
            if (profile.skills) {
                const skillCheckboxes = document.querySelectorAll('.skill-checkbox');
                skillCheckboxes.forEach(checkbox => {
                    checkbox.checked = profile.skills.includes(checkbox.value);
                });
            }

            // Set languages
            if (profile.languages) {
                const languageCheckboxes = document.querySelectorAll('.language-checkbox');
                languageCheckboxes.forEach(checkbox => {
                    checkbox.checked = profile.languages.includes(checkbox.value);
                });
            }

            // Set profile visibility toggle state
            const visibilityToggle = document.getElementById('profileVisibilityToggle');
            if (visibilityToggle) {
                visibilityToggle.checked = profile.status === 'active';
            }
            
            // Set availability toggle state
            const availabilityToggle = document.getElementById('availabilityToggle');
            if (availabilityToggle) {
                availabilityToggle.checked = profile.is_available !== false;
            }
        }

        // Handle profile photo upload with RLS
        document.getElementById('profilePhoto').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}-${Math.random()}.${fileExt}`;
                
                // Upload with RLS bucket policy
                const { error: uploadError } = await supabaseClient.storage
                    .from('profile-photos')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) {
                    if (uploadError.message.includes('permission denied')) {
                        throw new Error('Unauthorized to upload photos');
                    }
                    throw uploadError;
                }

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('profile-photos')
                    .getPublicUrl(fileName);

                document.getElementById('profilePhotoPreview').src = publicUrl;
                document.getElementById('placeholderIcon').classList.add('hidden');
            } catch (error) {
                console.error('Error uploading photo:', error);
                showError('Error uploading photo. Please try again.');
            }
        });

        // Handle form submission with RLS
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const formData = {
                    full_name: document.getElementById('fullName').value,
                    age_group: document.getElementById('ageGroup').value,
                    gender: document.getElementById('gender').value,
                    marital_status: document.getElementById('maritalStatus').value,
                    nationality: document.getElementById('nationality').value,
                    religion: document.getElementById('religion').value,
                    education: document.getElementById('education').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    emergency_contact: document.getElementById('emergencyContact').value,
                    years_of_experience: parseInt(document.getElementById('experience').value),
                    work_type: document.getElementById('workType').value,
                    preferred_time: document.getElementById('preferredTime').value,
                    expected_salary: parseInt(document.getElementById('salary').value),
                    work_location: document.getElementById('workLocation').value,
                    skills: Array.from(document.querySelectorAll('.skill-checkbox:checked')).map(checkbox => checkbox.value),
                    languages: Array.from(document.querySelectorAll('.language-checkbox:checked')).map(checkbox => checkbox.value),
                    additional_notes: document.getElementById('about').value,
                    is_available: document.getElementById('availabilityToggle').checked,
                    status: document.getElementById('profileVisibilityToggle').checked ? 'active' : 'inactive',
                    profile_photo: document.getElementById('profilePhotoPreview').src,
                    updated_at: new Date().toISOString()
                };

                // Update with RLS
                const { error } = await supabaseClient
                    .from('maid_profiles')
                    .update(formData)
                    .eq('user_id', currentUser.id);

                if (error) {
                    if (error.message.includes('permission denied')) {
                        throw new Error('Unauthorized to update profile');
                    }
                    throw error;
                }

                showSuccess('Profile updated successfully');
            } catch (error) {
                console.error('Error updating profile:', error);
                showError('Error updating profile. Please try again.');
            }
        });

        // Show error message
        function showError(message) {
            const toast = document.getElementById('errorToast');
            const messageEl = document.getElementById('errorMessage');
            messageEl.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const toast = document.getElementById('successToast');
            const messageEl = document.getElementById('successMessage');
            messageEl.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        // Handle user menu toggle
        const userMenuBtn = document.getElementById('userMenuBtn');
        const userDropdown = document.getElementById('user-dropdown');
        if (userMenuBtn && userDropdown) {
            userMenuBtn.addEventListener('click', () => {
                userDropdown.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.add('hidden');
                }
            });
        }

        // Handle sign out
        const signOutBtn = document.getElementById('signOutBtn');
        if (signOutBtn) {
            signOutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    window.location.href = '../auth/login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    showError('Failed to sign out');
                }
            });
        }

        // Load profile when page loads
        document.addEventListener('DOMContentLoaded', loadProfile);
    </script>
</body>
</html> 